<script>
const CLIENT_ID = '824420123974-lgbll4b8274mfjke7c23hobh08nar6b3.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

let tokenClient;
let gapiInited = false;

const authorizeButton = document.getElementById('authorize_button');
const signoutButton = document.getElementById('signout_button');
const fetchButton = document.getElementById('fetch_button');
const colorSelect = document.getElementById('colorSelect');
const content = document.getElementById('content');

authorizeButton.onclick = handleAuthClick;
signoutButton.onclick = handleSignoutClick;
fetchButton.onclick = listEventsByColor;

function gapiLoaded() {
  gapi.load('client', async () => {
    await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
    gapiInited = true;
  });
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: async (resp) => {
      if (resp.error !== undefined) {
        console.error(resp);
        return;
      }
      // ログイン成功後に UI を有効化
      authorizeButton.style.display = 'none';
      signoutButton.style.display = 'inline-block';
      colorSelect.disabled = false;
      fetchButton.disabled = false;
    }
  });
}

function handleAuthClick() {
  // 初回またはトークン期限切れのときは consent
  tokenClient.requestAccessToken({ prompt: 'consent' });
}

function handleSignoutClick() {
  const token = google.accounts.oauth2.getToken().access_token;
  if (token) google.accounts.oauth2.revoke(token);
  content.innerHTML = '';
  authorizeButton.style.display = 'inline-block';
  signoutButton.style.display = 'none';
  colorSelect.disabled = true;
  fetchButton.disabled = true;
}

async function listEventsByColor() {
  const colorId = colorSelect.value;
  if (!colorId) return alert('色を選んでください');

  try {
    const response = await gapi.client.calendar.events.list({
      calendarId: 'primary',
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 200,
      timeMin: new Date().toISOString(),
    });

    const events = response.result.items || [];
    const filtered = events.filter(e => e.colorId === colorId);

    if (!filtered.length) {
      content.innerHTML = `<p>選択した色の予定はありません。</p>`;
      return;
    }

    const html = filtered.map(e => {
      const start = e.start.dateTime || e.start.date;
      const end = e.end.dateTime || e.end.date;
      return `<li>${start} 〜 ${end}：<strong>${e.summary}</strong></li>`;
    }).join('');
    content.innerHTML = `<ul>${html}</ul>`;
  } catch (err) {
    content.innerText = err.message;
  }
}

gapiLoaded();
gisLoaded();
</script>
